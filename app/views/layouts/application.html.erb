<!DOCTYPE html>
<html>
<head>
  <title>Altereot</title>
  <%= include_gon %>
  <%= stylesheet_link_tag    "application", :media => "all" %>
  <%= javascript_include_tag "application" %>
  <%= csrf_meta_tags %>
  <%= yield :head %>
</head>
<body>
  <div id="header">
    <h1><%= link_to "Суть Времени", "/articles" %></h1>
    <% flash.each do |name, msg| %>
      <%= content_tag :div, msg, :id => "flash_#{name}", :class => "#{name}" %>
    <% end %>
  </div>
  <div id="main">
    <div id="filters">
      <%= yield :selected_filters %>
    </div>
    <div id='criterions' class='criterions inline'>
      <%= yield :criterions %>
    </div>
    <div id="articles" class='inline'>
      <%= yield :articles %>
    </div>
    <div id="aside" class='inline'>
      <div id="user_nav" class="inline">
        <% if current_user %>
        Logged in as <%= current_user.email %>.
        <%= link_to "Log out", logout_path %>
        <% else %>
        <%= link_to "Register", register_path %> or
        <%= link_to "log in", login_path %>
        <% end %>
      </div>
      <div id="new_article" class="inline">
        <%= link_to 'New Article', new_article_path %>
      </div>
      <div id="filters">
        <%= yield :filters %>
      </div>
    </div>
  </div>
  <div id="footer">
    <%= link_to "First", "http://vk.com/write202504" %>
    <%= link_to "Second", "http://vk.com/write846061" %>
    <%= link_to "Third", "http://vk.com/write19756683" %>
    <%= link_to "Fourth", "http://vk.com/write11253144" %>
    <script src="http://vkontakte.ru/js/api/openapi.js" type="text/javascript"></script>

    <div id="login_button" onclick="VK.Auth.login(authInfo);"></div>
    
    <p></p>
    <script language="javascript">
    $(document).ready(function(){
    var friends_data; // отсортированный список друзей

        VK.init(function() {
        // выполняем запрос получения списка друзей
        VK.api("friends.get", {fields:"first_name,photo"}, function(data) {
            // узнаем количество друзей
            var fr = data.response.length;
            // сортируем друзей по имени (функция sFirstName описана ниже)
            friends_data = data.response.sort(sFirstName);

            // в value элемента будем записывать номер пользователя в массиве friends_data
            for(var i=0;i<fr;i++){
                $('#friends_list').append('<option value="'+ i +'">'+ friends_data[i].first_name + ' ' + friends_data[i].last_name +'</option>');            
            }
            $("#friends_list").change(function () {
                // узнаем какой элемент выбран в select
                selectVal = $('#friends_list option:selected').val();
                if (selectVal!='') { // если выбран друг
                    // вытаскиваем из массива фотографию выбранного польователя по номеру в массиве
                    $('#user_info').html('<img src="'+ friends_data[selectVal].photo +'"/>');
                } else { // если выбрано "выберите друга"
                    // очищаем блок с аватаркой
                    $('#user_info').html('');
                }
            })
        });

        });

    $('#send_btn').click(function() {
        if ($('#friends_list option:selected').val()!='') { // если выбран пользователь
            if ($('#message_tf').val()!='') { // если введено сообщение
                uid_to = friends_data[$('#friends_list option:selected').val()].uid; // id выбранного пользователя
                message_to = $('#message_tf').val();   
                // отправляем запись на стену
                VK.api('wall.post',{owner_id:uid_to, message:message_to},function(data) {
                    if (data.response) { // если получен ответ
                        alert('Сообщение отправлено! ID сообщения: ' + data.response.post_id);
                    } else { // ошибка при отправке сообщения
                        alert('Ошибка! ' + data.error.error_code + ' ' + data.error.error_msg);
                    }
                });
            } else {
                alert('Введите сообщение!');
            }
        } else {
            alert('Выберите пользователя!');
        }

        return false;
    }); 

    });




    // функции сортировки
    function sFirstName(a,b) {
        if (a.first_name > b.first_name)
            return 1;
        else if  (a.first_name < b.first_name)
            return -1;
        else
            return 0;
    }
    VK.init({
      apiId: 3033796
    });
    function authInfo(response) {
      if (response.session) {
        alert('user: '+response.session.mid);
      } else {
        alert('not auth');
      }
    }
    
    alert(VK.Auth.getLoginStatus(authInfo));
    VK.UI.button('login_button');
    </script>
  </div>
</body>
</html>
      